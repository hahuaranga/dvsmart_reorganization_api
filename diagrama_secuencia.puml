@startuml
actor "Admin" as User
participant "Controller" as CTRL
participant "ShedLock" as LOCK
participant "StartReorganizeFullService" as SVC
participant "Spring Batch" as BATCH
participant "SftpMoveAndIndexItemWriter" as WRITER
participant "SFTP Session Pool" as POOL
participant "SFTP Server" as SFTP
database "MongoDB" as DB

User -> CTRL : POST /reorganize/full
CTRL -> SVC : execute()
activate SVC

SVC -> LOCK : tryLock("reorg_job")
alt Lock ya existe
    SVC <-- LOCK : fail
    CTRL <-- SVC : 409 Conflict / Error
else Lock adquirido
    SVC -> BATCH : launchJob()
    CTRL <-- SVC : 202 Accepted (JobId)
    
    == EjecuciÃ³n Batch (Async) ==
    BATCH -> WRITER : write(chunk)
    activate WRITER
    
    loop por cada archivo
        WRITER -> POOL : getSession()
        POOL -> SFTP : connect (lazy)
        WRITER -> SFTP : readStream()
        WRITER -> SFTP : writeStream()
        WRITER -> POOL : releaseSession()
    end
    
    WRITER -> DB : saveAudit()
    deactivate WRITER
    
    BATCH -> LOCK : releaseLock()
end
deactivate SVC
@enduml